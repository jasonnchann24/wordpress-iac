version: "3.9"

services:
  noop:
    image: nginx:alpine
    command: ["nginx", "-g", "daemon off;"]

  traefik:
    image: traefik:v3.0
    command:
      - "--log.level=INFO"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.cf.acme.dnschallenge=true"
      - "--certificatesresolvers.cf.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.cf.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.cf.acme.storage=/acme.json"
      - "--accesslog=true"
      - "--accesslog.filepath=/traefik/access.log"

    environment:
      - CF_DNS_API_TOKEN=${CF_API_TOKEN}
      - ACME_EMAIL=${ACME_EMAIL}

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/acme.json:/acme.json
      - ./traefik/access.log:/traefik/access.log

    restart: always

    labels:
      # HTTP â†’ HTTPS redirect
      - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

  wordpress:
    build: ./wordpress
    volumes:
      - wp_content:/var/www/html/wp-content
      - wp_html:/var/www/html
    env_file:
      - .env
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DOMAIN: ${WORDPRESS_DOMAIN}
      BASIC_AUTH: ${BASIC_AUTH}
    labels:
      - "traefik.enable=true"

      # Service definition
      - "traefik.http.services.wp.loadbalancer.server.port=80"

      # PUBLIC ROUTER
      - "traefik.http.routers.wp.rule=Host(`${WORDPRESS_DOMAIN}`)"
      - "traefik.http.routers.wp.entrypoints=websecure"
      - "traefik.http.routers.wp.tls.certresolver=cf"
      - "traefik.http.routers.wp.service=wp"
      - "traefik.http.routers.wp.middlewares=wp-rate-limit"
      - "traefik.http.routers.wp.priority=1"

      # Rate limiting middleware
      - "traefik.http.middlewares.wp-rate-limit.ratelimit.average=10"
      - "traefik.http.middlewares.wp-rate-limit.ratelimit.burst=20"

      - "traefik.http.middlewares.wp-login-rate-limit.ratelimit.average=3"
      - "traefik.http.middlewares.wp-login-rate-limit.ratelimit.burst=5"

      # HTTP Basic auth layer
      - "traefik.http.middlewares.wp-admin-auth.basicauth.users=${BASIC_AUTH}"

      # Router for /wp-admin and /wp-login.php and login
      - "traefik.http.routers.wp-admin.rule=Host(`${WORDPRESS_DOMAIN}`) && (PathPrefix(`/wp-admin`) || Path(`/wp-login.php`) || PathPrefix(`/login`) || PathPrefix(`/backoffice`))"
      - "traefik.http.routers.wp-admin.entrypoints=websecure"
      - "traefik.http.routers.wp-admin.tls.certresolver=cf"
      - "traefik.http.routers.wp-admin.middlewares=wp-admin-auth,wp-login-rate-limit"
    restart: always

  wp-cli:
    image: wordpress:cli-2.12
    container_name: wp-cli
    volumes:
      - wp_content:/var/www/html/wp-content
      - wp_html:/var/www/html
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DOMAIN: ${WORDPRESS_DOMAIN}
    entrypoint: ["sh", "-c"]
    command: |
      "while true; do
        wp --allow-root --path=/var/www/html action-scheduler run >/dev/null 2>&1
        sleep 30
      done"
    restart: always

  db:
    image: mariadb:10.11
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "127.0.0.1:3306:3306"
    volumes:
      - ./db-data:/var/lib/mysql
    restart: always

volumes:
  wp_content:
  wp_html:
